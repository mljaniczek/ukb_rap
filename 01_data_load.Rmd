---
title: "Untitled"
output: html_document
date: "2025-08-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
system('dx download pheno.csv')
system('dx download first_occurrences.csv')
system('dx download mets.csv')

load("analysis_variable_keys.Rdata")

library(tidyr)

install.packages("readr")


library(readr)


pheno <- read_csv("pheno.csv", name_repair = "universal_quiet")

mets <- read_csv("mets.csv", name_repair = "universal_quiet")

fo <- read_csv("first_occurrences.csv", name_repair = "universal_quiet") 
```

```{r}
# grab columns of occurrence
library(stringr)
library(tidyr)
library(dplyr)

event_key <- colnames(fo)[str_detect(colnames(fo), "Source")]
eventdate_key <- colnames(fo%>% select(-c( Sample.Measured.Date.and.Time...Instance.0)))[str_detect(colnames(fo%>% select(-c(Sample.Measured.Date.and.Time...Instance.0))), "Date")]

event <- fo %>%
  select(Participant.ID, all_of(event_key))

event_date <- fo  %>% select(Participant.ID, all_of(eventdate_key))

# go to longer
event_long <- event %>%
  pivot_longer(!Participant.ID, values_drop_na = TRUE) %>%
  group_by(Participant.ID) %>%
  mutate(id = row_number())

# grab date of first occurence
eventdate_long <- event_date %>%
  pivot_longer(!c(Participant.ID, Date.of.attending.assessment.centre...Instance.0), values_drop_na = TRUE) %>%
  group_by(Participant.ID) %>%
  mutate(id = row_number()) %>%
  mutate(afterassessment_fo = value > Date.of.attending.assessment.centre...Instance.0,
         beforeassessment_fo = value < Date.of.attending.assessment.centre...Instance.0)

# now grab icd10 codes

event_long <- event_long %>%
  mutate(name = str_to_lower(name)) %>%
  mutate(
    cad = ifelse(str_detect(name, c("i20|i21|i22|i23|i24|i25|z951|z955")),1,0),
    afib = ifelse(str_detect(name, c("i48")), 1, 0),
    stroke = ifelse(str_detect(name, c("i60|i61|i629|i63|i64|i678|i690|i693|g951|h341|h342|s066")),1,0),
    hypertension = ifelse(
      str_detect(
        name, c("i10|i11|i12|i13|i15|o10")
      ), 1,0
    ),
    diabetes_other = ifelse(str_detect(
      name, c("e10|e12|e13|e14") # separated out other diabetes 11/22/23
    ), 1, 0),
    diabetes_t2 = ifelse(str_detect(
      name, c("e11")
    ), 1, 0)
  )
```




